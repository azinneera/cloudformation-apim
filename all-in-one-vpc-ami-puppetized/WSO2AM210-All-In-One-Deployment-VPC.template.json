{
    "Resources": {
        "WSO2AMAnalyticsLC": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAnanlyticsAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "Ubuntu140464bit"
                    ]
                },
                "InstanceType": "t2.medium",
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "20",
                            "VolumeType": "gp2",
                            "DeleteOnTermination": "true"
                        }
                    }
                ],
                "KeyName": {
                    "Ref": "KeyPairName"
                },
                "SecurityGroups": [
                    {
                        "Ref": "ProductSecurityGroup"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash",
                                "set -e",
                                "mkdir -p /mnt/efs",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "echo \"",
                                            {
                                                "Ref": "AMNFSMount"
                                            },
                                            ".efs.",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            ".amazonaws.com",
                                            ":/ /mnt/efs nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 0 0\" >> /etc/fstab"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_ELB_DNS_NAME/",
                                            {
                                                "Fn::GetAtt": [
                                                    "WSO2AMELB",
                                                    "DNSName"
                                                ]
                                            },
                                            "/g\" /etc/puppet/hieradata/dev/wso2/wso2am_runtime/pattern-1/default.yaml"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_DB_USERNAME/",
                                            {
                                                "Ref": "DBUsername"
                                            },
                                            "/g\" /etc/puppet/hieradata/dev/wso2/common.yaml"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_DB_PASSWORD/",
                                            {
                                                "Ref": "DBPassword"
                                            },
                                            "/g\" /etc/puppet/hieradata/dev/wso2/common.yaml"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_RDS_URL/",
                                            {
                                                "Fn::GetAtt": [
                                                    "WSO2AMDB",
                                                    "Endpoint.Address"
                                                ]
                                            },
                                            "/g\" /etc/puppet/hieradata/dev/wso2/common.yaml"
                                        ]
                                    ]
                                },
                                "mount -a -t nfs4",
                                "export DB_NAME=WSO2AM_DB",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DB_HOSTNAME=",
                                            {
                                                "Fn::GetAtt": [
                                                    "WSO2AMDB",
                                                    "Endpoint.Address"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DB_PORT=",
                                            {
                                                "Fn::GetAtt": [
                                                    "WSO2AMDB",
                                                    "Endpoint.Port"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DB_USERNAME=",
                                            {
                                                "Ref": "DBUsername"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DB_PASSWORD=",
                                            {
                                                "Ref": "DBPassword"
                                            }
                                        ]
                                    ]
                                },
                                "echo \"Waiting for Cluster lock...\"",
                                "bash /usr/local/bin/acquire_lock.sh",
                                "export FACTER_product_name=wso2am_runtime",
                                "export FACTER_product_version=2.1.0",
                                "export FACTER_product_profile=default",
                                "export FACTER_vm_type=openstack",
                                "export FACTER_environment=dev",
                                "export FACTER_platform=default",
                                "export FACTER_use_hieradata=true",
                                "export FACTER_pattern=pattern-1",
                                "puppet apply -e \"include wso2am_runtime\" --modulepath=/etc/puppet/modules --hiera_config=/etc/puppet/hiera.yaml",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_DB_USERNAME/",
                                            {
                                                "Ref": "DBUsername"
                                            },
                                            "/g\" /usr/local/bin/provision_db_apim.sh"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_DB_PASSWORD/",
                                            {
                                                "Ref": "DBPassword"
                                            },
                                            "/g\" /usr/local/bin/provision_db_apim.sh"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_DB_HOST/",
                                            {
                                                "Fn::GetAtt": [
                                                    "WSO2AMDB",
                                                    "Endpoint.Address"
                                                ]
                                            },
                                            "/g\" /usr/local/bin/provision_db_apim.sh"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sed -i \"s/CF_DB_PORT/",
                                            {
                                                "Fn::GetAtt": [
                                                    "WSO2AMDB",
                                                    "Endpoint.Port"
                                                ]
                                            },
                                            "/g\" /usr/local/bin/provision_db_apim.sh"
                                        ]
                                    ]
                                },
                                "bash /usr/local/bin/provision_db_apim.sh",
                                "echo \"Releasing lock...\"",
                                "/usr/local/bin/sync_lock apim unlock",
                                "if [ ! -d \"/mnt/efs/synapse-configs\" ]; then",
                                "    mkdir -p /mnt/efs/synapse-configs",
                                "    cp -r /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs /mnt/efs/synapse-configs",
                                "fi",
                                "rm -rf /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs",
                                "ln -s /mnt/efs/synapse-configs/synapse-configs /mnt/wso2am-2.1.0/repository/deployment/server/synapse-configs",
                                "apt-get --purge remove puppet mysql-client -y",
                                "rm -rf /etc/puppet",
                                "/mnt/wso2am-2.1.0/bin/wso2server.sh start",
                                "echo 'export HISTTIMEFORMAT=\"%F %T \"' >> /etc/profile.d/history.sh",
                                "cat /dev/null > ~/.bash_history && history -c"
                            ]
                        ]
                    }
                }
            }
        }
    }
}
