AWSTemplateFormatVersion: 2010-09-09
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Cluster Configuration
        Parameters:
          - APIMClusterSize
          - APIMClusterMax
          - ProductInstanceType
          - KeyPairName
          - AWSAccessKeyID
          - AWSAccessKeySecret
      - Label:
          default: Network Configuration
        Parameters:
          - CertificateName
      - Label:
          default: Database Configuration
        Parameters:
          - DBInstanceType
          - DBSize
          - DBUsername
          - DBPassword
    ParameterLabels:
      APIMClusterSize:
        default: How many instances should the APIM Cluster contain?
      APIMClusterMax:
        default: How many maximum instances should the APIM Cluster scale up to?
      ProductInstanceType:
        default: EC2 Instance type for the APIM instances
      AWSAccessKeyID:
        default: AWS Access Key ID
      AWSAccessKeySecret:
        default: AWS Access Secret Key
      CertificateName:
        default: Which certificate should be used at the Load Balancer for APIM?
      DBInstanceType:
        default: RDS Instance type for the APIM Database?
      DBSize:
        default: How large should APIM database should be?
      DBUsername:
        default: APIM Database Master username?
      DBPassword:
        default: APIM Database Master password
  'AWS::CloudFormation::Designer':
    c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2:
      size:
        width: 520
        height: 270
      position:
        x: -4580
        'y': -620
      z: 1
      embeds:
        - 21d07bfc-0717-46fa-9325-5eb52ad71c83
        - f3cdfe70-41d8-423b-8043-b5588d320330
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
        - 977bd553-1eca-42e8-80ca-d06efa92fc2c
        - e2cf773b-7ade-41a8-9edd-8f35f6d369d7
        - e803fa6d-1f40-44df-a758-8b44f434eb0f
        - a873c9a5-f1c1-4955-8485-c532254dad8e
        - 449ab838-562f-4716-ac0c-b6ff97c368b9
        - 3f971707-256d-47c5-a68e-e5ab0728e152
    e2cf773b-7ade-41a8-9edd-8f35f6d369d7:
      size:
        width: 80
        height: 80
      position:
        x: -4550
        'y': -560
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds:
        - f3b8bca6-ba9f-4547-975d-fff7b56b5d6d
    4f6d7998-3ba6-40a2-8a02-19a91c756908:
      size:
        width: 60
        height: 60
      position:
        x: -5010
        'y': -750
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds: []
    e1b716e6-0636-44a8-a88e-b9c679e00efd:
      source:
        id: 4f6d7998-3ba6-40a2-8a02-19a91c756908
      target:
        id: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      z: 2
    0c6a6593-1ece-4ea6-a375-faf74b62a6b2:
      size:
        width: 60
        height: 60
      position:
        x: -4770
        'y': -530
      z: 0
      embeds: []
      isrelatedto:
        - c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
    977bd553-1eca-42e8-80ca-d06efa92fc2c:
      size:
        width: 80
        height: 80
      position:
        x: -4450
        'y': -560
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds:
        - 0b559c64-1251-44be-86e6-e55d89462462
    cf4ad471-855d-4129-bd88-3a21a4caab78:
      size:
        width: 60
        height: 60
      position:
        x: -5070
        'y': -620
      z: 3
      parent: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      embeds: []
    91c5365f-9914-43ad-b8bf-ccd30d95e309:
      source:
        id: 977bd553-1eca-42e8-80ca-d06efa92fc2c
      target:
        id: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      z: 2
    0b559c64-1251-44be-86e6-e55d89462462:
      size:
        width: 60
        height: 60
      position:
        x: -4440
        'y': -550
      z: 3
      parent: 977bd553-1eca-42e8-80ca-d06efa92fc2c
      embeds: []
      references:
        - 0c6a6593-1ece-4ea6-a375-faf74b62a6b2
    52b537bf-aa49-4fba-8e81-a27c630eb747:
      source:
        id: 0b559c64-1251-44be-86e6-e55d89462462
      target:
        id: 0c6a6593-1ece-4ea6-a375-faf74b62a6b2
      z: 5
    7c0999f8-5cfe-4b5e-8719-3aa18030ed01:
      size:
        width: 60
        height: 60
      position:
        x: -4830
        'y': -620
      z: 3
      parent: 9a0cbff1-168f-4d60-a912-110365f8933b
      embeds: []
    a585cc83-c457-4d52-85bf-8fe714d6302b:
      source:
        id: 0c6a6593-1ece-4ea6-a375-faf74b62a6b2
      target:
        id: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      z: 0
    5ce139ad-4dd4-4cf0-aca5-08029aee6eec:
      source:
        id: d4c668f0-ab82-4cf1-a377-e2f5d792e079
      target:
        id: 84568a5c-d633-40e4-a970-800a21224d24
      z: 4
    92fed6de-d0bb-4c9e-ade4-ba7f35dee2ff:
      source:
        id: d4c668f0-ab82-4cf1-a377-e2f5d792e079
      target:
        id: 84568a5c-d633-40e4-a970-800a21224d24
      z: 4
    449ab838-562f-4716-ac0c-b6ff97c368b9:
      size:
        width: 60
        height: 60
      position:
        x: -4270
        'y': -430
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds: []
      ismemberof:
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      dependson:
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
        - a873c9a5-f1c1-4955-8485-c532254dad8e
      isrelatedto:
        - c923fc1a-40b9-4c51-a288-6477f32b3219
        - a873c9a5-f1c1-4955-8485-c532254dad8e
        - f3b8bca6-ba9f-4547-975d-fff7b56b5d6d
    c6bb6de6-531f-4bff-9b29-ad95c678e79b:
      source:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      target:
        id: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      z: 4
    56c87c09-c78a-4cde-887f-b8bcb87dbd35:
      size:
        width: 60
        height: 60
      position:
        x: -4150
        'y': -590
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds: []
      isrelatedto:
        - 84568a5c-d633-40e4-a970-800a21224d24
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
    95c27dea-05f1-4cae-8b36-390fcddbbced:
      source:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      target:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      z: 4
    3f971707-256d-47c5-a68e-e5ab0728e152:
      size:
        width: 60
        height: 60
      position:
        x: -4270
        'y': -510
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds: []
      isconnectedto:
        - a873c9a5-f1c1-4955-8485-c532254dad8e
        - 9a0cbff1-168f-4d60-a912-110365f8933b
        - e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      isassociatedwith:
        - 449ab838-562f-4716-ac0c-b6ff97c368b9
      dependson:
        - 449ab838-562f-4716-ac0c-b6ff97c368b9
        - a873c9a5-f1c1-4955-8485-c532254dad8e
    be448209-beee-4cd8-b856-6613de7346e1:
      source:
        id: 3f971707-256d-47c5-a68e-e5ab0728e152
      target:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      z: 5
    1b710fe0-ec7b-4c72-8874-f4bd92c88c0a:
      source:
        id: 3f971707-256d-47c5-a68e-e5ab0728e152
      target:
        id: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      z: 11
    5d387bd6-75e6-4719-af84-8ff332faad1d:
      source:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      target:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      z: 11
    a873c9a5-f1c1-4955-8485-c532254dad8e:
      size:
        width: 60
        height: 60
      position:
        x: -4270
        'y': -590
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds: []
      isconnectedto:
        - e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      ismemberof:
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      dependson:
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
    c2e248a1-dc42-4df6-9cd7-aeaeefd0fd7c:
      source:
        id: a873c9a5-f1c1-4955-8485-c532254dad8e
      target:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      z: 11
    b1a6c048-1720-4419-a3f9-2ada9335a9de:
      source:
        id: a873c9a5-f1c1-4955-8485-c532254dad8e
      target:
        id: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      z: 12
    16346f02-e313-48d4-a93d-5d96cd6f7433:
      source:
        id: 3f971707-256d-47c5-a68e-e5ab0728e152
      target:
        id: a873c9a5-f1c1-4955-8485-c532254dad8e
      z: 13
    de7ee385-0508-4c4f-a318-0d7e59a2a400:
      source:
        id: 3f971707-256d-47c5-a68e-e5ab0728e152
      target:
        id: 9a0cbff1-168f-4d60-a912-110365f8933b
      z: 14
    e354e03c-91aa-48df-8a91-0ead57f7281c:
      source:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      target:
        id: 84568a5c-d633-40e4-a970-800a21224d24
      z: 4
    1b173d86-ec69-43ca-9a29-30712ee7dc53:
      source:
        id: a873c9a5-f1c1-4955-8485-c532254dad8e
      target:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      z: 5
    349c36ee-1b09-43a9-9ec2-5f6713724f19:
      source:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      target:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      z: 6
    c19cf564-d402-4bb7-bf57-239811fcfac9:
      source:
        id: 3f971707-256d-47c5-a68e-e5ab0728e152
      target:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      z: 7
    cc2a0878-c939-4037-9fe9-adee9185778b:
      source:
        id: 3f971707-256d-47c5-a68e-e5ab0728e152
      target:
        id: a873c9a5-f1c1-4955-8485-c532254dad8e
      z: 8
    f5bd26f4-744d-4421-ab01-2bf865daf07c:
      source:
        id: 5f929353-a443-4711-a696-512169532f1a
      target:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      z: 4
    2b1d9bea-72be-48ba-a9c8-a632441b0311:
      source:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      target:
        id: 5f929353-a443-4711-a696-512169532f1a
      z: 4
    c923fc1a-40b9-4c51-a288-6477f32b3219:
      size:
        width: 60
        height: 60
      position:
        x: -4150
        'y': -460
      z: 3
      parent: e803fa6d-1f40-44df-a758-8b44f434eb0f
      embeds: []
      ismemberof:
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      isrelatedto:
        - e2cf773b-7ade-41a8-9edd-8f35f6d369d7
    82b3feca-e9d0-4f81-be6d-319f449e80a1:
      source:
        id: 0979f871-e850-492d-89a4-4e2a706fca71
      target:
        id: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      z: 4
    fc39e52b-f39b-4d01-8399-76a712c844b5:
      source:
        id: 0979f871-e850-492d-89a4-4e2a706fca71
      target:
        id: 9a0cbff1-168f-4d60-a912-110365f8933b
      z: 4
    e803fa6d-1f40-44df-a758-8b44f434eb0f:
      size:
        width: 80
        height: 90
      position:
        x: -4160
        'y': -480
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds:
        - c923fc1a-40b9-4c51-a288-6477f32b3219
      isconnectedto:
        - 9a0cbff1-168f-4d60-a912-110365f8933b
        - e2cf773b-7ade-41a8-9edd-8f35f6d369d7
        - f3cdfe70-41d8-423b-8043-b5588d320330
    5b708e2b-5ee0-48c2-beec-d1f63212fba3:
      source:
        id: e803fa6d-1f40-44df-a758-8b44f434eb0f
      target:
        id: 9a0cbff1-168f-4d60-a912-110365f8933b
      z: 4
    2545d78f-eecf-485c-a068-ebf794240ca3:
      source:
        id: e803fa6d-1f40-44df-a758-8b44f434eb0f
      target:
        id: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      z: 5
    f3cdfe70-41d8-423b-8043-b5588d320330:
      size:
        width: 80
        height: 80
      position:
        x: -4550
        'y': -460
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds: []
    21d07bfc-0717-46fa-9325-5eb52ad71c83:
      size:
        width: 80
        height: 80
      position:
        x: -4450
        'y': -460
      z: 2
      parent: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
      embeds:
        - c628636d-6d86-4649-a71e-ff6a1b41a493
    c628636d-6d86-4649-a71e-ff6a1b41a493:
      size:
        width: 60
        height: 60
      position:
        x: -4440
        'y': -450
      z: 3
      parent: 21d07bfc-0717-46fa-9325-5eb52ad71c83
      embeds: []
      references:
        - 0c6a6593-1ece-4ea6-a375-faf74b62a6b2
    7c399c2f-0dc5-42b7-a950-3c1c4d927ed5:
      source:
        id: 21d07bfc-0717-46fa-9325-5eb52ad71c83
      target:
        id: f3cdfe70-41d8-423b-8043-b5588d320330
      z: 2
    98d58bbd-ea6d-4e89-9288-bc94b82c07f1:
      source:
        id: e803fa6d-1f40-44df-a758-8b44f434eb0f
      target:
        id: f3cdfe70-41d8-423b-8043-b5588d320330
      z: 4
    6464f4cf-7f13-46d2-8313-5079e8d2d535:
      source:
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
      target:
        id: a873c9a5-f1c1-4955-8485-c532254dad8e
      z: 4
    f3b8bca6-ba9f-4547-975d-fff7b56b5d6d:
      size:
        width: 60
        height: 60
      position:
        x: -4540
        'y': -550
      z: 3
      parent: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
      embeds: []
    df2fd95f-67f8-4dc9-b048-dbc4c8c76f49:
      size:
        width: 60
        height: 60
      position:
        x: -4260
        'y': -700
      z: 0
      embeds: []
      ismemberof:
        - 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      references:
        - f3b8bca6-ba9f-4547-975d-fff7b56b5d6d
    9b6efb0c-8e5b-44b1-9eb9-88f6ad80f25c:
      source:
        id: df2fd95f-67f8-4dc9-b048-dbc4c8c76f49
      target:
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
      z: 4
    48871175-ffc2-44c6-91f8-d17abe6cd52a:
      source:
        id: df2fd95f-67f8-4dc9-b048-dbc4c8c76f49
      target:
        id: f3b8bca6-ba9f-4547-975d-fff7b56b5d6d
      z: 5
Resources:
  WSO2AM1SIMPLE1VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c53a8b27-6fd3-4b11-b6d2-ea1f76ba36b2
  PublicSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
      CidrBlock: 10.0.254.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - '0'
        - !GetAZs ''
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e2cf773b-7ade-41a8-9edd-8f35f6d369d7
  PublicInternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0c6a6593-1ece-4ea6-a375-faf74b62a6b2
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 977bd553-1eca-42e8-80ca-d06efa92fc2c
  EC2SRTA4ALO8:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 91c5365f-9914-43ad-b8bf-ccd30d95e309
  PublicRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      GatewayId: !Ref PublicInternetGateway
      DestinationCidrBlock: 0.0.0.0/0
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0b559c64-1251-44be-86e6-e55d89462462
  EC2VPCG1W38G:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref PublicInternetGateway
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a585cc83-c457-4d52-85bf-8fe714d6302b
  WSO2AMLC:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      AssociatePublicIpAddress: true
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - Ubuntu140464bit
      InstanceType: !Ref ProductInstanceType
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: '20'
            VolumeType: gp2
            DeleteOnTermination: 'true'
      KeyName: !Ref KeyPairName
      SecurityGroups:
        - !Ref ProductSecurityGroup
      UserData: !Base64
        'Fn::Join':
          - |+

          - - '#!/bin/bash'
            - export JAVA_HOME="/opt/java"
            - >-
              public_ip=$(curl
              http://169.254.169.254/latest/meta-data/public-ipv4)
            - >-
              sed -i "s/IP_ADDRESS/$public_ip/g"
              /opt/wso2am-2.1.0/repository/conf/carbon.xml
            - !Join
              - ''
              - - sed -i "s/ELB_HOSTNAME/
                - !GetAtt
                  - WSO2AMELB
                  - DNSName
                - /g" /opt/wso2am-2.1.0/repository/conf/api-manager.xml
            - !Join
              - ''
              - - sed -i "s/DB_HOST/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
                - >-
                  /g"
                  /opt/wso2am-2.1.0/repository/conf/datasources/master-datasources.xml
            - !Join
              - ''
              - - sed -i "s/DB_USERNAME/
                - !Ref DBUsername
                - >-
                  /g"
                  /opt/wso2am-2.1.0/repository/conf/datasources/master-datasources.xml
            - !Join
              - ''
              - - sed -i "s/DB_PASSWORD/
                - !Ref DBPassword
                - >-
                  /g"
                  /opt/wso2am-2.1.0/repository/conf/datasources/master-datasources.xml
            - !Join
              - ''
              - - sed -i "s/DB_HOST/
                - !GetAtt
                  - WSO2AMDB
                  - Endpoint.Address
                - /g" /opt/wso2am-2.1.0/repository/conf/registry.xml
            - !Join
              - ''
              - - sed -i "s/AWS_ACCESS_KEY/
                - !Ref AWSAccessKeyID
                - /g" /opt/wso2am-2.1.0/repository/conf/axis2/axis2.xml
            - !Join
              - ''
              - - sed -i "s/AWS_SECRET_KEY/
                - !Ref AWSAccessKeySecret
                - /g" /opt/wso2am-2.1.0/repository/conf/axis2/axis2.xml
            - !Join
              - ''
              - - sed -i "s/AWS_SECURITY_GROUP/
                - !Ref ProductSecurityGroup
                - /g" /opt/wso2am-2.1.0/repository/conf/axis2/axis2.xml
            - !Join
              - ''
              - - sed -i "s/AWS_REGION/
                - !Ref 'AWS::Region'
                - /g" /opt/wso2am-2.1.0/repository/conf/axis2/axis2.xml
            - >-
              sed -i "s/AWS_CLUSTER_TAG_NAME/Cluster/g"
              /opt/wso2am-2.1.0/repository/conf/axis2/axis2.xml
            - >-
              sed -i "s/AWS_CLUSTER_TAG_VALUE/WSO2AM210SIMPLE/g"
              /opt/wso2am-2.1.0/repository/conf/axis2/axis2.xml
            - cp -r /opt/wso2am-2.1.0/repository/deployment/server /tmp/
            - !Join
              - ''
              - - echo "
                - !Ref AMNFSMount
                - .efs.
                - !Ref 'AWS::Region'
                - .amazonaws.com
                - >-
                  :/ /opt/wso2am-2.1.0/repository/deployment/server nfs4
                  nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
                  0 0" >> /etc/fstab
            - mount -a -t nfs4
            - >-
              cp -r /tmp/server/*
              /opt/wso2am-2.1.0/repository/deployment/server/
            - /opt/wso2am-2.1.0/bin/wso2server.sh -Dsetup start
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 449ab838-562f-4716-ac0c-b6ff97c368b9
    DependsOn:
      - ProductSecurityGroup
      - WSO2AMELB
  ProductSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Product Security Group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '2049'
          ToPort: '2049'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9443'
          ToPort: '9443'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '5701'
          ToPort: '5701'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9763'
          ToPort: '9763'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '8243'
          ToPort: '8243'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '8280'
          ToPort: '8280'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '3306'
          ToPort: '3306'
          CidrIp: 0.0.0.0/0
        - IpProtocol: ICMP
          FromPort: '-1'
          ToPort: '-1'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '3306'
          ToPort: '3306'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '10389'
          ToPort: '10389'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '8000'
          ToPort: '8000'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '5701'
          ToPort: '5701'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '5672'
          ToPort: '5672'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9611'
          ToPort: '9611'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '9711'
          ToPort: '9711'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '10397'
          ToPort: '10397'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: '0'
          ToPort: '0'
          CidrIp: 0.0.0.0/0
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 56c87c09-c78a-4cde-887f-b8bcb87dbd35
  WSO2AMASGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      LaunchConfigurationName: !Ref WSO2AMLC
      DesiredCapacity: !Ref APIMClusterSize
      MinSize: 1
      MaxSize: !Ref APIMClusterMax
      LoadBalancerNames:
        - !Ref WSO2AMELB
      VPCZoneIdentifier:
        - !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: WSO2AM-Instance
          PropagateAtLaunch: 'true'
        - Key: Product
          Value: WSO2AM
          PropagateAtLaunch: 'true'
        - Key: Version
          Value: 2.1.0
          PropagateAtLaunch: 'true'
        - Key: Cluster
          Value: WSO2AM210SIMPLE
          PropagateAtLaunch: 'true'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3f971707-256d-47c5-a68e-e5ab0728e152
    DependsOn:
      - WSO2AMLC
  WSO2AMELB:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      CrossZone: true
      SecurityGroups:
        - !Ref ProductSecurityGroup
      Subnets:
        - !Ref PublicSubnet
      Listeners:
        - LoadBalancerPort: '9443'
          InstancePort: '9443'
          Protocol: HTTPS
          InstanceProtocol: HTTPS
          SSLCertificateId: !Join
            - ''
            - - 'arn:aws:iam::'
              - !Ref 'AWS::AccountId'
              - ':server-certificate'
              - /
              - !Ref CertificateName
        - LoadBalancerPort: '8243'
          InstancePort: '8243'
          Protocol: HTTPS
          InstanceProtocol: HTTPS
          SSLCertificateId: !Join
            - ''
            - - 'arn:aws:iam::'
              - !Ref 'AWS::AccountId'
              - ':server-certificate'
              - /
              - !Ref CertificateName
        - LoadBalancerPort: '9763'
          InstancePort: '9763'
          Protocol: HTTP
          InstanceProtocol: HTTP
        - LoadBalancerPort: '10389'
          InstancePort: '10389'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '8000'
          InstancePort: '8000'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '5701'
          InstancePort: '5701'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '5672'
          InstancePort: '5672'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9611'
          InstancePort: '9611'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '9711'
          InstancePort: '9711'
          Protocol: TCP
          InstanceProtocol: TCP
        - LoadBalancerPort: '10397'
          InstancePort: '10397'
          Protocol: TCP
          InstanceProtocol: TCP
      HealthCheck:
        Target: 'TCP:9763'
        HealthyThreshold: '3'
        UnhealthyThreshold: '5'
        Interval: '10'
        Timeout: '5'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a873c9a5-f1c1-4955-8485-c532254dad8e
    DependsOn:
      - ProductSecurityGroup
  WSO2AMDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      VPCSecurityGroups:
        - !Ref ProductSecurityGroup
      DBInstanceClass: !Ref DBInstanceType
      AllocatedStorage: !Ref DBSize
      BackupRetentionPeriod: '0'
      DBInstanceIdentifier: wso2amdb
      DBName: WSO2AM_DB
      Engine: MySQL
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      MultiAZ: 'false'
      StorageType: gp2
      DBSubnetGroupName: !Ref RDSDBSG412ZQ
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c923fc1a-40b9-4c51-a288-6477f32b3219
  RDSDBSG412ZQ:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: DB Subnet Group
      SubnetIds:
        - !Ref PublicSubnet
        - !Ref PublicSubnet2
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e803fa6d-1f40-44df-a758-8b44f434eb0f
  PublicSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
      CidrBlock: 10.0.252.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - '1'
        - !GetAZs ''
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f3cdfe70-41d8-423b-8043-b5588d320330
  PublicRouteTable2:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref WSO2AM1SIMPLE1VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 21d07bfc-0717-46fa-9325-5eb52ad71c83
  PublicRoute2:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRouteTable2
      GatewayId: !Ref PublicInternetGateway
      DestinationCidrBlock: 0.0.0.0/0
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c628636d-6d86-4649-a71e-ff6a1b41a493
  EC2SRTA21VEF:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRouteTable2
      SubnetId: !Ref PublicSubnet2
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 7c399c2f-0dc5-42b7-a950-3c1c4d927ed5
  AMNFSMount:
    Type: 'AWS::EFS::FileSystem'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f3b8bca6-ba9f-4547-975d-fff7b56b5d6d
  AMMountTarget:
    Type: 'AWS::EFS::MountTarget'
    Properties:
      SecurityGroups:
        - !Ref ProductSecurityGroup
      FileSystemId: !Ref AMNFSMount
      SubnetId: !Ref PublicSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: df2fd95f-67f8-4dc9-b048-dbc4c8c76f49
Outputs:
  Carbon:
    Value: !Join
      - ''
      - - 'https://'
        - !GetAtt
          - WSO2AMELB
          - DNSName
        - ':9443/carbon'
    Description: WSO2 AM Carbon Console URL
  Credentials:
    Value: !Join
      - ''
      - - 'Username: admin, '
        - 'Password: admin'
    Description: >-
      WSO2 API Manager Admin Credentials. Please refer
      https://docs.wso2.com/display/AM210/Maintaining+Logins+and+passwords to
      change credentials.
Parameters:
  KeyPairName:
    Description: >-
      The key pair to establish a SSH connection to the web servers. This should
      be already created.
    Type: 'AWS::EC2::KeyPair::KeyName'
  CertificateName:
    Description: A previously uploaded certificate to use at the Load Balancer Listeners.
    Type: String
    MinLength: 1
  AWSAccessKeyID:
    Description: The access key ID to be used in AWS based Clustering for WSO2 Products.
    Type: String
    MinLength: 16
  AWSAccessKeySecret:
    Description: >-
      The secret access key to be used in AWS based Clustering for WSO2
      Products.
    Type: String
    MinLength: 1
  ProductInstanceType:
    Description: The EC2 instance type to be used for the WSO2 AM instances.
    Type: String
    Default: t2.small
    AllowedValues:
      - t1.micro
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - m1.small
      - m1.medium
      - m1.large
      - m1.xlarge
      - m2.xlarge
      - m2.2xlarge
      - m2.4xlarge
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - c1.medium
      - c1.xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - g2.2xlarge
      - g2.8xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - hi1.4xlarge
      - hs1.8xlarge
      - cr1.8xlarge
      - cc2.8xlarge
      - cg1.4xlarge
  APIMClusterSize:
    Description: >-
      The number of instances of WSO2 API Manager to spawn. This can be
      increased later through the AutoScale Group.
    Type: Number
    Default: 1
  APIMClusterMax:
    Description: The maximum number of instances of WSO2 API Manager to scale up to.
    Type: Number
    Default: 2
  DBInstanceType:
    Description: The DB instance type of the RDS instance to be used  for WSO2 AM.
    Type: String
    Default: db.t2.micro
    AllowedValues:
      - db.t1.micro
      - db.m1.small
      - db.m1.medium
      - db.m1.large
      - db.m1.xlarge
      - db.m2.xlarge
      - db.m2.2xlarge
      - db.m2.4xlarge
      - db.m3.medium
      - db.m3.large
      - db.m3.xlarge
      - db.m3.2xlarge
      - db.m4.large
      - db.m4.xlarge
      - db.m4.2xlarge
      - db.m4.4xlarge
      - db.m4.10xlarge
      - db.r3.large
      - db.r3.xlarge
      - db.r3.2xlarge
      - db.r3.4xlarge
      - db.r3.8xlarge
      - db.m2.xlarge
      - db.m2.2xlarge
      - db.m2.4xlarge
      - db.cr1.8xlarge
      - db.t2.micro
      - db.t2.small
      - db.t2.medium
      - db.t2.large
  DBSize:
    Description: The DB size (in GB) to be used for WSO2 AM.
    Type: Number
    Default: 5
  DBUsername:
    Description: The username to be used in the WSO2 AM DB.
    Type: String
    Default: root
    MinLength: 4
    AllowedPattern: '[A-Za-z0-9\-]+'
  DBPassword:
    Description: The passworf to be used in the WSO2 AM DB.
    Type: String
    Default: rootrootroot
    MinLength: 8
    NoEcho: true
Mappings:
  AWSAMIRegionMap:
    ap-northeast-1:
      Ubuntu140464bit: ami-cd0a3baa
    ap-northeast-2:
      Ubuntu140464bit: ami-b2dc01dc
    ap-south-1:
      Ubuntu140464bit: ami-60deac0f
    ap-southeast-1:
      Ubuntu140464bit: ami-6701bb04
    ap-southeast-2:
      Ubuntu140464bit: ami-dad0dbb9
    ca-central-1:
      Ubuntu140464bit: ami-ef8d318b
    eu-central-1:
      Ubuntu140464bit: ami-e3459a8c
    eu-west-1:
      Ubuntu140464bit: ami-ba5854dc
    eu-west-2:
      Ubuntu140464bit: ami-dca6b2b8
    sa-east-1:
      Ubuntu140464bit: ami-7380ec1f
    us-east-1:
      Ubuntu140464bit: ami-51f09e47
    us-east-2:
      Ubuntu140464bit: ami-81f4d3e4
    us-west-1:
      Ubuntu140464bit: ami-35735555
